# Day 14 — MINI PROJECT

## 1️⃣ Terraform — Create EC2 (any instance type) with vpc, subnet, internet GW, route table and EC2

provider "aws" {
  region = "ap-south-1"
}

# VPC
resource "aws_vpc" "PathnexVPC" {
  cidr_block = "10.0.0.0/16"
}

# subnet

resource "aws_subnet" "Pathnex_subnet" {
  vpc_id = "aws_vpc.PathnexVPC.id"
  cidr_block = "10.0.1.0/24"
  map_public_ip_on_launch = true
}

# Internet GW

resource "aws_internet_gateway" "Pathnex_IGW" {
  vpc_id = aws_vpc.PathnexVPC.id
}


# Route Table

resource "aws_route_table" "Pathnex_route_table" {
  vpc_id = aws_vpc.pathnexVPC.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.Pathnex_IGW.id
  }
}

# Route Table association 

resouce "aws_route_table_association" "Pathnex_RTA" {
  subnet.id = "aws_subnet.Pathnex_subnet.id"
  route_table.id = aws_route_table.Pathnex_route_table.id
}

# Security Group 

resource "aws_security_group" "PathnexSG" {
  vpc_id = aws_vpc.PathnexVPC.id

  ingress {
    from_port = 22
    to_port = 22
    protocol = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port = 22
    to_port = 22
    protocol = "-1"             # all protocols allowed
    cidr_blocks = ["0.0.0.0/0"]
    }
}

# EC2

resource "aws_instance" "PathnexEC2" {
  ami = "ami-09nkhskfehjlje" 
  instance_type = "c5.xlarge"
  subnet_id = "aws_subnet.Pathnex_subnet.id"
  vpc_security_group.id = [aws_security_group.PathnexSG.id]

  tags {
    name = "Pathnex-Ec2"
  }
}



# Scheduled Pipelines

## Jenkins Pipeline — Scheduled Build

pipeline {
  agent any 
  environment {
      INSTITUTE_NAME = "pathnex"
  }

  triggers {
      cron('H 2 * * *') // every day at 2 AM
  }
  stages {
      stage('checkout') {
             steps {
                git url: 'https://github.com/Pathnex/sample-java-app.git'
            }
        }
      stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
    }
}



##  GitLab CI — Scheduled Pipeline

stages:
  - build

build:
  stage: build
  image: maven:3.8.1-jdk-17
  script:
    - git clone https://github.com/Pathnex/sample-java-app.git
    - cd sample-java-app
    - mvn clean package

    